{% extends "base.html" %}
{% block title %}{{ session.title }}{% endblock %}

{% block header_nav %}
<a href="{{ url_for('dashboard') }}" class="nav-link"><i class="fa-solid fa-arrow-left"></i> Dashboard</a>
<a href="{{ url_for('edit_session', session_id=session.id) }}" class="nav-link"><i class="fa-solid fa-pen"></i> Edit</a>
<button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">
    <i class="fa-solid fa-moon"></i>
</button>
{% endblock %}

{% block content %}
<div class="container">

    <!-- ═══ SESSION HEADER ═══ -->
    <div class="session-header">
        <div class="session-header-text">
            <span class="type-badge type-badge--{{ session.type }}">
                <i class="fa-solid {{ types[session.type].icon }}"></i>
                {{ types[session.type].label }}
            </span>
            <h2>{{ session.title }}</h2>
            {% if session.subtitle %}<p class="session-subtitle">{{ session.subtitle }}</p>{% endif %}
        </div>
        <div class="session-meta">
            {% if session.date %}
            <span><i class="fa-regular fa-calendar"></i> {{ session.date }}</span>
            {% endif %}
            {% if session.format %}
            <span><i class="fa-solid fa-video"></i> {{ session.format }}</span>
            {% endif %}
        </div>
    </div>

    <!-- ═══ STATS BANNER ═══ -->
    {% if session.stats_banner %}
    <div class="stats-banner">
        {% for s in session.stats_banner %}
        <div class="stat-card">
            <div class="stat-value">{{ s.value }}</div>
            <div class="stat-label">{{ s.label }}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- ═══ MODE TABS ═══ -->
    <div class="mode-tabs">
        <button class="mode-tab active" data-mode="notes" onclick="switchMode('notes', this)">
            <i class="fa-solid fa-file-lines"></i> Speaker Notes
        </button>
        <button class="mode-tab" data-mode="teleprompter" onclick="switchMode('teleprompter', this)">
            <i class="fa-solid fa-tv"></i> Rehearsal
        </button>
        <button class="mode-tab" data-mode="practice" onclick="switchMode('practice', this)">
            <i class="fa-solid fa-dumbbell"></i> Practice
        </button>
        <button class="mode-tab" data-mode="cheatsheet" onclick="switchMode('cheatsheet', this)">
            <i class="fa-solid fa-table-cells-large"></i> Quick Ref
        </button>
        {% if session.type == 'pitch' %}
        <button class="mode-tab" data-mode="pitch" onclick="switchMode('pitch', this)">
            <i class="fa-solid fa-rocket"></i> Pitch Timer
        </button>
        {% endif %}
    </div>

    <!-- ══════════════════════════════════════════════════════
         MODE: SPEAKER NOTES
         ══════════════════════════════════════════════════════ -->
    <div class="mode-panel visible" id="panel-notes">

        <!-- Confidence Summary Dashboard -->
        {% if session.talking_points %}
        <div class="confidence-dashboard" id="confidence-dashboard">
            <div class="confidence-header">
                <h3><i class="fa-solid fa-chart-line"></i> Confidence Tracker</h3>
                <div class="confidence-overall" id="confidence-overall">
                    <span class="confidence-overall-score" id="confidence-overall-score">—</span>
                    <span class="confidence-overall-label">Overall Readiness</span>
                </div>
            </div>
            <div class="confidence-bars" id="confidence-bars">
                {% for tp in session.talking_points %}
                <div class="confidence-bar-row" data-tp-idx="{{ loop.index0 }}">
                    <span class="confidence-bar-label">{{ tp.label }}</span>
                    <div class="confidence-bar-track">
                        <div class="confidence-bar-fill" id="conf-bar-{{ loop.index0 }}"></div>
                    </div>
                    <span class="confidence-bar-val" id="conf-val-{{ loop.index0 }}">—</span>
                </div>
                {% endfor %}
            </div>
            <div class="confidence-actions">
                <button class="btn btn-ghost btn-sm" onclick="resetConfidence()">
                    <i class="fa-solid fa-rotate-left"></i> Reset Ratings
                </button>
                <span class="confidence-hint"><i class="fa-solid fa-info-circle"></i> Rate each talking point below to track your readiness</span>
            </div>
        </div>
        {% endif %}

        <!-- Tips bar -->
        {% if session.tips %}
        <div class="tips-bar">
            <h3><i class="fa-solid fa-lightbulb"></i>
                {% if session.type == 'interview' %}On-Camera Tips
                {% elif session.type == 'presentation' %}Presentation Tips
                {% else %}Pitch Tips{% endif %}
            </h3>
            <ul class="tips-list">
                {% for tip in session.tips %}
                <li>{{ tip|safe }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Topic filter -->
        {% if session.talking_points %}
        <div class="topic-nav">
            <button class="topic-chip active" onclick="filterTopic('all', this)">All</button>
            {% set seen = [] %}
            {% for tp in session.talking_points %}
                {% if tp.id not in seen %}
                <button class="topic-chip" onclick="filterTopic('{{ tp.id }}', this)">{{ tp.label }}</button>
                {% if seen.append(tp.id) %}{% endif %}
                {% endif %}
            {% endfor %}
        </div>

        <!-- Talking point cards -->
        {% for tp in session.talking_points %}
        <div class="tp-card" data-topic="{{ tp.id }}" data-tp-idx="{{ loop.index0 }}">
            <div class="tp-card-header">
                <span class="tp-number">{{ tp.number }}</span>
                {% if tp.timing %}<span class="tp-timing"><i class="fa-regular fa-clock"></i> {{ tp.timing }}</span>{% endif %}
                <!-- Confidence rating -->
                <div class="tp-confidence" data-idx="{{ loop.index0 }}">
                    <button class="conf-btn" onclick="rateConfidence({{ loop.index0 }}, 1)" data-level="1" title="Not confident"><i class="fa-solid fa-face-frown"></i></button>
                    <button class="conf-btn" onclick="rateConfidence({{ loop.index0 }}, 2)" data-level="2" title="Needs work"><i class="fa-solid fa-face-meh"></i></button>
                    <button class="conf-btn" onclick="rateConfidence({{ loop.index0 }}, 3)" data-level="3" title="Getting there"><i class="fa-solid fa-face-smile"></i></button>
                    <button class="conf-btn" onclick="rateConfidence({{ loop.index0 }}, 4)" data-level="4" title="Confident"><i class="fa-solid fa-face-grin"></i></button>
                    <button class="conf-btn" onclick="rateConfidence({{ loop.index0 }}, 5)" data-level="5" title="Nailed it"><i class="fa-solid fa-face-grin-stars"></i></button>
                </div>
            </div>
            <div class="tp-question">{{ tp.question }}</div>
            <div class="tp-note">{{ tp.note|safe }}</div>

            {% if tp.tip_do or tp.tip_dont %}
            <div class="tp-tips-grid">
                {% if tp.tip_do %}
                <div class="tip-do">
                    <strong><i class="fa-solid fa-check"></i> Do say</strong>
                    <span>{{ tp.tip_do }}</span>
                </div>
                {% endif %}
                {% if tp.tip_dont %}
                <div class="tip-dont">
                    <strong><i class="fa-solid fa-xmark"></i> Avoid</strong>
                    <span>{{ tp.tip_dont }}</span>
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% if tp.source %}
            <span class="tp-source"><i class="fa-solid fa-bookmark"></i> {{ tp.source }}</span>
            {% endif %}
        </div>
        {% endfor %}

        {% else %}
        <div class="empty-inline">
            <p>No talking points yet. <a href="{{ url_for('edit_session', session_id=session.id) }}">Add some in the editor.</a></p>
        </div>
        {% endif %}
    </div>

    <!-- ══════════════════════════════════════════════════════
         MODE: TELEPROMPTER / REHEARSAL
         ══════════════════════════════════════════════════════ -->
    <div class="mode-panel" id="panel-teleprompter">
        {% if session.talking_points %}

        <!-- Rehearsal controls -->
        <div class="teleprompter-controls">
            <div class="teleprompter-controls-left">
                <button class="btn btn-primary" id="rehearsal-play-btn" onclick="toggleRehearsal()">
                    <i class="fa-solid fa-play"></i> Start Rehearsal
                </button>
                <button class="btn btn-ghost" onclick="resetRehearsal()">
                    <i class="fa-solid fa-rotate-left"></i> Reset
                </button>
            </div>
            <div class="teleprompter-controls-center">
                <div class="rehearsal-timer-display" id="rehearsal-timer">0:00</div>
                <div class="rehearsal-progress-text" id="rehearsal-slide-counter">
                    Slide <span id="rehearsal-current">1</span> of {{ session.talking_points|length }}
                </div>
            </div>
            <div class="teleprompter-controls-right">
                <label class="font-size-control">
                    <i class="fa-solid fa-text-height"></i>
                    <input type="range" min="1" max="4" value="2" id="teleprompter-font-size" onchange="setTeleprompterFontSize(this.value)">
                </label>
                <button class="btn btn-ghost btn-sm" onclick="toggleTeleprompterFullscreen()" title="Fullscreen">
                    <i class="fa-solid fa-expand"></i>
                </button>
            </div>
        </div>

        <!-- Slide navigation dots -->
        <div class="teleprompter-dots" id="teleprompter-dots">
            {% for tp in session.talking_points %}
            <button class="teleprompter-dot{% if loop.first %} active{% endif %}"
                    onclick="goToRehearsalSlide({{ loop.index0 }})"
                    title="{{ tp.label }}: {{ tp.question }}">
                <span class="dot-number">{{ loop.index }}</span>
            </button>
            {% endfor %}
        </div>

        <!-- Main teleprompter display -->
        <div class="teleprompter-display" id="teleprompter-display">
            {% for tp in session.talking_points %}
            <div class="teleprompter-slide{% if loop.first %} active{% endif %}" data-slide="{{ loop.index0 }}">
                <div class="teleprompter-slide-header">
                    <span class="teleprompter-slide-num">{{ tp.number }}</span>
                    {% if tp.timing %}<span class="teleprompter-slide-timing"><i class="fa-regular fa-clock"></i> {{ tp.timing }}</span>{% endif %}
                </div>
                <div class="teleprompter-slide-title">{{ tp.question }}</div>
                <div class="teleprompter-slide-notes">{{ tp.note|safe }}</div>
                {% if tp.tip_do %}
                <div class="teleprompter-cue teleprompter-cue--do">
                    <i class="fa-solid fa-check-circle"></i> {{ tp.tip_do }}
                </div>
                {% endif %}
                {% if tp.tip_dont %}
                <div class="teleprompter-cue teleprompter-cue--dont">
                    <i class="fa-solid fa-circle-xmark"></i> {{ tp.tip_dont }}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- Navigation buttons -->
        <div class="teleprompter-nav">
            <button class="btn btn-ghost btn-lg" onclick="prevRehearsalSlide()" id="rehearsal-prev">
                <i class="fa-solid fa-arrow-left"></i> Previous
            </button>
            <button class="btn btn-primary btn-lg" onclick="nextRehearsalSlide()" id="rehearsal-next">
                Next <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>

        <div class="practice-footer">
            <span><i class="fa-solid fa-keyboard"></i> Shortcuts: <kbd>&larr;</kbd> prev &middot; <kbd>&rarr;</kbd> next &middot; <kbd>Space</kbd> timer &middot; <kbd>F</kbd> fullscreen</span>
        </div>

        {% else %}
        <div class="empty-inline">
            <p>No talking points yet. <a href="{{ url_for('edit_session', session_id=session.id) }}">Add some in the editor.</a></p>
        </div>
        {% endif %}
    </div>

    <!-- ══════════════════════════════════════════════════════
         MODE: PRACTICE
         ══════════════════════════════════════════════════════ -->
    <div class="mode-panel" id="panel-practice">
        {% if session.practice_questions %}
        <!-- Practice session history ribbon -->
        <div class="practice-history-ribbon" id="practice-history-ribbon">
            <div class="history-ribbon-left">
                <i class="fa-solid fa-chart-bar"></i>
                <span id="history-sessions-count">0</span> past sessions &middot;
                Avg. rating: <span id="history-avg-rating">—</span>/5
            </div>
            <div class="history-ribbon-right">
                <button class="btn btn-ghost btn-sm" onclick="toggleHistoryPanel()">
                    <i class="fa-solid fa-clock-rotate-left"></i> History
                </button>
                <button class="btn btn-ghost btn-sm" onclick="clearPracticeHistory()">
                    <i class="fa-solid fa-trash-can"></i> Clear
                </button>
            </div>
        </div>

        <!-- Expandable history detail -->
        <div class="practice-history-panel" id="practice-history-panel" style="display:none">
            <h4><i class="fa-solid fa-clock-rotate-left"></i> Practice Session History</h4>
            <div class="history-entries" id="history-entries">
                <p class="history-empty">No practice history yet. Complete a practice session to see results here.</p>
            </div>
        </div>

        <div class="practice-progress">
            <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
            <span class="progress-text" id="progress-text">0 / {{ session.practice_questions|length }}</span>
        </div>

        <div class="practice-card" id="practice-card">
            <!-- Timer -->
            <div class="timer-section">
                <div class="timer-display" id="timer-display">0:00</div>
                <div class="timer-label">Response Timer</div>
                <div class="timer-targets">
                    <span class="timer-target green">0:00 - 1:30 <i class="fa-solid fa-check"></i></span>
                    <span class="timer-target orange">1:30 - 2:00 <i class="fa-solid fa-triangle-exclamation"></i></span>
                    <span class="timer-target red">2:00+ <i class="fa-solid fa-xmark"></i></span>
                </div>
            </div>

            <!-- Question -->
            <div class="practice-question" id="practice-question"></div>

            <!-- Controls -->
            <div class="practice-controls">
                <button class="btn btn-primary" onclick="toggleTimer()" id="timer-btn">
                    <i class="fa-solid fa-play"></i> Start Timer
                </button>
                <button class="btn btn-accent" onclick="revealAnswer()">
                    <i class="fa-solid fa-lightbulb"></i> Key Points
                </button>
                <button class="btn btn-ghost" onclick="nextPracticeQuestion()">
                    Next <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>

            <!-- Reveal box -->
            <div class="reveal-box" id="reveal-box"></div>

            <!-- Self-rating -->
            <div class="self-rating" id="self-rating" style="display:none">
                <p>How did you do?</p>
                <div class="stars">
                    <button onclick="rateAnswer(1)"><i class="fa-solid fa-star"></i></button>
                    <button onclick="rateAnswer(2)"><i class="fa-solid fa-star"></i></button>
                    <button onclick="rateAnswer(3)"><i class="fa-solid fa-star"></i></button>
                    <button onclick="rateAnswer(4)"><i class="fa-solid fa-star"></i></button>
                    <button onclick="rateAnswer(5)"><i class="fa-solid fa-star"></i></button>
                </div>
            </div>
        </div>

        <div class="practice-footer">
            <span><i class="fa-solid fa-keyboard"></i> Shortcuts: <kbd>Space</kbd> timer &middot; <kbd>&rarr;</kbd> next &middot; <kbd>R</kbd> reveal</span>
        </div>

        {% else %}
        <div class="empty-inline">
            <p>No practice questions yet. <a href="{{ url_for('edit_session', session_id=session.id) }}">Add some in the editor.</a></p>
        </div>
        {% endif %}
    </div>

    <!-- ══════════════════════════════════════════════════════
         MODE: CHEAT SHEET
         ══════════════════════════════════════════════════════ -->
    <div class="mode-panel" id="panel-cheatsheet">
        {% if session.cheatsheet_cards %}
        <div class="cheatsheet-header">
            <h3 class="cheatsheet-title"><i class="fa-solid fa-table-cells-large"></i> Quick Reference Card</h3>
            <button class="btn btn-ghost btn-sm" onclick="printQuickRef()">
                <i class="fa-solid fa-print"></i> Print Quick Ref
            </button>
        </div>
        <div class="cheatsheet-grid">
            {% for card in session.cheatsheet_cards %}
            <div class="cheat-card">
                <h3>{{ card.icon }} {{ card.title }}</h3>
                <ul>
                    {% for item in card['items'] %}
                    <li>
                        <span>{{ item[0] }}</span>
                        {% if item[1] %}<span class="cheat-val">{{ item[1] }}</span>{% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-inline">
            <p>No cheat sheet cards yet. <a href="{{ url_for('edit_session', session_id=session.id) }}">Add some in the editor.</a></p>
        </div>
        {% endif %}
    </div>

    <!-- ══════════════════════════════════════════════════════
         MODE: PITCH TIMER (pitch type only)
         ══════════════════════════════════════════════════════ -->
    {% if session.type == 'pitch' %}
    <div class="mode-panel" id="panel-pitch">

        <!-- Pitch variant selector -->
        <div class="pitch-variant-bar">
            <button class="pitch-var-btn active" onclick="selectPitchVariant(30, this)">30-Second</button>
            <button class="pitch-var-btn" onclick="selectPitchVariant(60, this)">60-Second</button>
            <button class="pitch-var-btn" onclick="selectPitchVariant(120, this)">2-Minute</button>
        </div>

        <!-- Countdown -->
        <div class="pitch-timer-card">
            <div class="pitch-countdown" id="pitch-countdown">0:30</div>
            <div class="pitch-ring" id="pitch-ring">
                <svg viewBox="0 0 200 200">
                    <circle cx="100" cy="100" r="90" class="ring-bg"/>
                    <circle cx="100" cy="100" r="90" class="ring-fill" id="ring-fill"
                            stroke-dasharray="565.48" stroke-dashoffset="0"/>
                </svg>
            </div>
            <div class="pitch-controls">
                <button class="btn btn-primary btn-lg" onclick="togglePitchTimer()" id="pitch-btn">
                    <i class="fa-solid fa-play"></i> Start
                </button>
                <button class="btn btn-ghost" onclick="resetPitchTimer()">
                    <i class="fa-solid fa-rotate-left"></i> Reset
                </button>
            </div>
        </div>

        <!-- Key Messages Checklist -->
        {% if session.key_messages %}
        <div class="key-messages-card">
            <h3><i class="fa-solid fa-list-check"></i> Key Messages to Hit</h3>
            <div class="checklist">
                {% for msg in session.key_messages %}
                <label class="check-item">
                    <input type="checkbox"> <span>{{ msg }}</span>
                </label>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Pitch Text -->
        {% if session.pitch_variants %}
        <div class="pitch-text-card" id="pitch-text-card">
            <h3><i class="fa-solid fa-scroll"></i> Pitch Script</h3>
            <div class="pitch-text" id="pitch-text">
                {{ session.pitch_variants.get('30sec', 'No 30-second pitch script yet.')|safe }}
            </div>
        </div>
        {% endif %}

        <!-- Objection Handling -->
        {% if session.objections %}
        <div class="objections-card">
            <h3><i class="fa-solid fa-shield-halved"></i> Objection Handling</h3>
            {% for obj in session.objections %}
            <div class="objection-item">
                <div class="objection-q"><i class="fa-solid fa-circle-question"></i> {{ obj.objection }}</div>
                <div class="objection-a"><i class="fa-solid fa-circle-check"></i> {{ obj.response }}</div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

    </div>
    {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script>
// Inject session data for JS
const SESSION = {{ session_json|safe }};
</script>
<script src="{{ url_for('static', filename='js/session.js') }}"></script>
{% endblock %}
